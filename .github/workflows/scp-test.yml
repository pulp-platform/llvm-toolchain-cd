# Copyright 2020 ETH Zurich and University of Bologna.
# Licensed under the Apache License, Version 2.0, see LICENSE for details.
# SPDX-License-Identifier: Apache-2.0

name: scp-test

on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04
    env:
      PKGVERS: riscv32-snitch-llvm-ubuntu2004.tar.gz
    steps:
      ########################################
      ## Build Docker image and publish to pulp-platform's GHCR.
      ########################################
      - 
        name: Checkout
        uses: actions/checkout@v2
        uses: docker/setup-buildx-action@v1
      - 
        name: Fetch Toolchain
        run: |
          wget https://sourceforge.net/projects/snitch-llvm/files/nightly/riscv32-snitch-llvm-ubuntu2004.tar.gz/download \
            -O riscv32-snitch-llvm-ubuntu2004.tar.gz
      -
        name: GHCR Log-in
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: noah95
          password: ${{ secrets.PAT_DOCKER }}
      - name: Build and push
        uses: docker/build-push-action@v2
        with:
          context: .
          file: docker/snitch-llvm.Dockerfile
          build-args: |
            TCTAR=${PKGVERS}.tar.gz
          tags: ghcr.io/pulp-platform/snitch-toolchain-cd/snitch-llvm:latest
          push: true
